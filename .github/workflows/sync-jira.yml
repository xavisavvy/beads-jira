name: Sync Jira to Beads

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch: # Manual trigger
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
          - dry-run

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check Jira configuration
        id: check-config
        run: |
          if [ -z "${{ secrets.JIRA_HOST }}" ] || [ -z "${{ secrets.JIRA_EMAIL }}" ] || [ -z "${{ secrets.JIRA_API_TOKEN }}" ] || [ -z "${{ secrets.JIRA_PROJECT_KEY }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::Jira is not configured. Skipping sync. To enable, set JIRA_HOST, JIRA_EMAIL, JIRA_API_TOKEN, and JIRA_PROJECT_KEY secrets."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check-config.outputs.configured == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.check-config.outputs.configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check-config.outputs.configured == 'true'
        run: npm ci

      - name: Configure Git
        if: steps.check-config.outputs.configured == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Jira Sync
        if: steps.check-config.outputs.configured == 'true'
        env:
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          BEADS_PROJECT_PATH: ${{ github.workspace }}
          SYNC_MODE: ${{ inputs.sync_mode || 'auto' }}
        run: npm run sync

      - name: Create Pull Request
        if: steps.check-config.outputs.configured == 'true' && success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync Jira issues to Beads'
          branch: sync/jira-to-beads
          delete-branch: true
          title: 'chore: Sync Jira issues to Beads'
          body: |
            ## Automated Jira Sync
            
            This PR was automatically created by the Jira sync workflow.
            
            ### Changes
            - Synced issues from Jira project `${{ secrets.JIRA_PROJECT_KEY }}`
            - Updated `.beads/` directory with latest issue data
            
            ### Review
            - [ ] Verify issue metadata is correct
            - [ ] Check for any conflicts or duplicates
            - [ ] Confirm assignees and labels are accurate
            
            ---
            *Generated by GitHub Actions workflow*
          labels: |
            automated
            sync
            jira
