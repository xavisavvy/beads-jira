name: Sync Jira to Beads

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch: # Manual trigger
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
          - dry-run

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run Jira Sync
        env:
          JIRA_HOST: ${{ secrets.JIRA_HOST }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          BEADS_PROJECT_PATH: ${{ github.workspace }}
          SYNC_MODE: ${{ inputs.sync_mode || 'auto' }}
        run: npm run sync

      - name: Create Pull Request
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync Jira issues to Beads'
          branch: sync/jira-to-beads
          delete-branch: true
          title: 'chore: Sync Jira issues to Beads'
          body: |
            ## Automated Jira Sync
            
            This PR was automatically created by the Jira sync workflow.
            
            ### Changes
            - Synced issues from Jira project `${{ secrets.JIRA_PROJECT_KEY }}`
            - Updated `.beads/` directory with latest issue data
            
            ### Review
            - [ ] Verify issue metadata is correct
            - [ ] Check for any conflicts or duplicates
            - [ ] Confirm assignees and labels are accurate
            
            ---
            *Generated by GitHub Actions workflow*
          labels: |
            automated
            sync
            jira
