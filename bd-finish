#!/bin/bash
# bd-finish - Finish a beads issue and create a PR
# 
# Usage: bd-finish <issue-id> [options]
# Example: bd-finish bd-a1b2
#          bd-finish bd-a1b2 --draft
#          bd-finish bd-a1b2 --no-push

set -e

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

show_help() {
    echo "Usage: bd-finish <issue-id> [options]"
    echo ""
    echo "Finishes a beads issue and creates a pull request"
    echo ""
    echo "Options:"
    echo "  --draft        Create as draft PR"
    echo "  --no-push      Don't push to remote (just mark done locally)"
    echo "  --help, -h     Show this help"
    echo ""
    echo "Examples:"
    echo "  bd-finish bd-a1b2"
    echo "  bd-finish bd-a1b2 --draft"
    echo "  bd-finish bd-a1b2 --no-push"
}

if [ $# -eq 0 ] || [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    show_help
    exit 0
fi

ISSUE_ID=$1
DRAFT_FLAG=""
NO_PUSH=false

# Parse options
shift
while [ $# -gt 0 ]; do
    case "$1" in
        --draft)
            DRAFT_FLAG="--draft"
            shift
            ;;
        --no-push)
            NO_PUSH=true
            shift
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

echo -e "${BLUE}Finishing issue $ISSUE_ID...${NC}"

# Get issue details from beads
ISSUE_JSON=$(bd show "$ISSUE_ID" --json 2>/dev/null || echo "")

if [ -z "$ISSUE_JSON" ]; then
    echo -e "${RED}‚ùå Issue $ISSUE_ID not found${NC}"
    exit 1
fi

# Extract issue details
ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
ISSUE_TYPE=$(echo "$ISSUE_JSON" | jq -r '.type')
ISSUE_STATUS=$(echo "$ISSUE_JSON" | jq -r '.status')
ISSUE_LABELS=$(echo "$ISSUE_JSON" | jq -r '.labels[]' 2>/dev/null || echo "")

# Find Jira key from labels
JIRA_KEY=$(echo "$ISSUE_LABELS" | grep -E '^[A-Z]+-[0-9]+$' | head -1 || echo "")

echo -e "${BLUE}üìã Issue: $ISSUE_TITLE${NC}"
echo -e "${BLUE}üè∑Ô∏è  Type: $ISSUE_TYPE${NC}"
if [ -n "$JIRA_KEY" ]; then
    echo -e "${BLUE}üé´ Jira: $JIRA_KEY${NC}"
fi
echo ""

# Check if there are uncommitted changes
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  You have uncommitted changes.${NC}"
    echo "Please commit your changes first:"
    echo "  git add ."
    if [ -n "$JIRA_KEY" ]; then
        echo "  git commit -m \"Your message ($ISSUE_ID $JIRA_KEY)\""
    else
        echo "  git commit -m \"Your message ($ISSUE_ID)\""
    fi
    exit 1
fi

# Mark issue as done
bd done "$ISSUE_ID"
echo -e "${GREEN}‚úì Marked issue as done${NC}"

if [ "$NO_PUSH" = true ]; then
    echo -e "${GREEN}Done! (not pushing to remote)${NC}"
    exit 0
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ "$CURRENT_BRANCH" = "main" || "$CURRENT_BRANCH" = "master" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  You're on $CURRENT_BRANCH branch.${NC}"
    echo "No pull request needed."
    exit 0
fi

echo -e "${BLUE}üåø Current branch: $CURRENT_BRANCH${NC}"

# Push to remote
echo -e "${BLUE}Pushing to remote...${NC}"
git push -u origin "$CURRENT_BRANCH"
echo -e "${GREEN}‚úì Pushed to origin/$CURRENT_BRANCH${NC}"

# Detect git hosting platform
REMOTE_URL=$(git config --get remote.origin.url)
echo -e "${BLUE}üîó Remote: $REMOTE_URL${NC}"

# Determine platform
PLATFORM=""
if echo "$REMOTE_URL" | grep -q "github.com"; then
    PLATFORM="github"
elif echo "$REMOTE_URL" | grep -q "bitbucket.org"; then
    PLATFORM="bitbucket"
elif echo "$REMOTE_URL" | grep -q "gitlab.com"; then
    PLATFORM="gitlab"
else
    # Check for self-hosted instances
    if echo "$REMOTE_URL" | grep -qi "gitlab"; then
        PLATFORM="gitlab"
    elif echo "$REMOTE_URL" | grep -qi "bitbucket"; then
        PLATFORM="bitbucket"
    else
        PLATFORM="other"
    fi
fi

echo -e "${BLUE}üì¶ Platform: $PLATFORM${NC}"
echo ""

# Build PR title and body
if [ -n "$JIRA_KEY" ]; then
    PR_TITLE="$JIRA_KEY: $ISSUE_TITLE"
    PR_BODY="Closes $ISSUE_ID / $JIRA_KEY

## Changes
- 

## Testing
- 

## Related
- Jira: $JIRA_KEY
- Beads: $ISSUE_ID"
else
    PR_TITLE="$ISSUE_TITLE"
    PR_BODY="Closes $ISSUE_ID

## Changes
- 

## Testing
- "
fi

# Create PR based on platform
case "$PLATFORM" in
    github)
        if command -v gh &> /dev/null; then
            echo -e "${BLUE}Creating GitHub PR...${NC}"
            gh pr create --title "$PR_TITLE" --body "$PR_BODY" $DRAFT_FLAG
            echo -e "${GREEN}‚úì Pull request created!${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  'gh' CLI not installed.${NC}"
            echo "Install it: https://cli.github.com/"
            echo ""
            echo "Or create PR manually:"
            echo "  https://github.com/$(git config --get remote.origin.url | sed 's/.*github.com[:/]\(.*\)\.git/\1/')/compare/$CURRENT_BRANCH?expand=1"
        fi
        ;;
    
    bitbucket)
        # Extract repo details from URL
        REPO_PATH=$(echo "$REMOTE_URL" | sed -E 's#.*bitbucket.org[:/]([^/]+/[^/.]+)(\.git)?#\1#')
        
        if command -v bb &> /dev/null; then
            echo -e "${BLUE}Creating Bitbucket PR...${NC}"
            bb pr create --title "$PR_TITLE" --description "$PR_BODY"
            echo -e "${GREEN}‚úì Pull request created!${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  Bitbucket CLI not installed.${NC}"
            echo ""
            echo "Create PR manually:"
            echo "  https://bitbucket.org/$REPO_PATH/pull-requests/new?source=$CURRENT_BRANCH"
        fi
        ;;
    
    gitlab)
        # Extract repo details
        REPO_PATH=$(echo "$REMOTE_URL" | sed -E 's#.*gitlab[^/]*[:/]([^/]+/[^/.]+)(\.git)?#\1#')
        
        if command -v glab &> /dev/null; then
            echo -e "${BLUE}Creating GitLab MR...${NC}"
            glab mr create --title "$PR_TITLE" --description "$PR_BODY" $([ -n "$DRAFT_FLAG" ] && echo "--draft")
            echo -e "${GREEN}‚úì Merge request created!${NC}"
        else
            echo -e "${YELLOW}‚ö†Ô∏è  'glab' CLI not installed.${NC}"
            echo "Install it: https://gitlab.com/gitlab-org/cli"
            echo ""
            echo "Or create MR manually:"
            echo "  https://gitlab.com/$REPO_PATH/-/merge_requests/new?merge_request[source_branch]=$CURRENT_BRANCH"
        fi
        ;;
    
    other)
        echo -e "${YELLOW}‚ö†Ô∏è  Unknown git platform.${NC}"
        echo ""
        echo "Branch pushed to: $CURRENT_BRANCH"
        echo "Remote: $REMOTE_URL"
        echo ""
        echo "Create pull request manually in your git platform's web UI."
        ;;
esac

echo ""
echo -e "${GREEN}üéâ All done!${NC}"
echo ""
echo "Issue $ISSUE_ID is marked as done."
echo "Branch $CURRENT_BRANCH has been pushed."
