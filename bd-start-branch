#!/bin/bash
# bd-start-branch - Start working on a beads issue with automatic branch creation
# 
# Usage: bd-start-branch <issue-id>
# Example: bd-start-branch bd-a1b2

set -e

if [ $# -eq 0 ]; then
    echo "Usage: bd-start-branch <issue-id>"
    echo ""
    echo "Starts a beads issue and creates a git feature branch"
    echo ""
    echo "Example:"
    echo "  bd-start-branch bd-a1b2"
    exit 1
fi

ISSUE_ID=$1

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${BLUE}Starting issue $ISSUE_ID...${NC}"

# Get issue details from beads
ISSUE_JSON=$(bd show "$ISSUE_ID" --json 2>/dev/null || echo "")

if [ -z "$ISSUE_JSON" ]; then
    echo "‚ùå Issue $ISSUE_ID not found"
    exit 1
fi

# Extract issue title and labels
ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r '.title')
ISSUE_TYPE=$(echo "$ISSUE_JSON" | jq -r '.type')
ISSUE_LABELS=$(echo "$ISSUE_JSON" | jq -r '.labels[]' 2>/dev/null || echo "")

# Find Jira key from labels (format: PROJ-123)
JIRA_KEY=$(echo "$ISSUE_LABELS" | grep -E '^[A-Z]+-[0-9]+$' | head -1 || echo "")

# Create branch name
# Format: <type>/<jira-key>-<slugified-title>
# Example: feature/FRONT-234-fix-button-alignment

# Slugify title (lowercase, replace spaces with hyphens, remove special chars)
SLUG=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9 -]//g' | sed 's/ /-/g' | cut -c1-50)

if [ -n "$JIRA_KEY" ]; then
    BRANCH_NAME="${ISSUE_TYPE}/${JIRA_KEY}-${SLUG}"
else
    BRANCH_NAME="${ISSUE_TYPE}/${ISSUE_ID}-${SLUG}"
fi

echo -e "${BLUE}üìã Issue: $ISSUE_TITLE${NC}"
echo -e "${BLUE}üè∑Ô∏è  Type: $ISSUE_TYPE${NC}"
if [ -n "$JIRA_KEY" ]; then
    echo -e "${BLUE}üé´ Jira: $JIRA_KEY${NC}"
fi
echo -e "${BLUE}üåø Branch: $BRANCH_NAME${NC}"
echo ""

# Check if we're on a clean working directory
if ! git diff-index --quiet HEAD -- 2>/dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  You have uncommitted changes.${NC}"
    read -p "Continue anyway? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 1
    fi
fi

# Make sure we're on main/master
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [[ "$CURRENT_BRANCH" != "main" && "$CURRENT_BRANCH" != "master" ]]; then
    echo -e "${YELLOW}‚ö†Ô∏è  You're on branch '$CURRENT_BRANCH', not main/master.${NC}"
    read -p "Create branch from current branch? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Cancelled. Switch to main first:"
        echo "  git checkout main"
        exit 1
    fi
fi

# Create and checkout branch
if git show-ref --verify --quiet refs/heads/"$BRANCH_NAME"; then
    echo -e "${YELLOW}‚ö†Ô∏è  Branch '$BRANCH_NAME' already exists.${NC}"
    read -p "Check it out? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        git checkout "$BRANCH_NAME"
    else
        echo "Cancelled."
        exit 1
    fi
else
    git checkout -b "$BRANCH_NAME"
    echo -e "${GREEN}‚úì Created and checked out branch: $BRANCH_NAME${NC}"
fi

# Start the beads issue
bd start "$ISSUE_ID"
echo -e "${GREEN}‚úì Started issue: $ISSUE_ID${NC}"

echo ""
echo -e "${GREEN}üöÄ Ready to work!${NC}"
echo ""
echo "Next steps:"
echo "  1. Make your changes"
echo "  2. Commit with: git commit -m \"Your message ($ISSUE_ID"
if [ -n "$JIRA_KEY" ]; then
    echo "     $JIRA_KEY)\""
else
    echo ")\""
fi
echo "  3. When done: bd done $ISSUE_ID"
echo "  4. Push and create PR"
