name: Sync Issues to Beads

# Sync issues from {{ISSUE_TRACKER_NAME}} to local beads repository
# Generated by HiveForge - https://hiveforge.sh

on:
  schedule:
    - cron: '{{SCHEDULE}}'
  workflow_dispatch:
    inputs:
      sync_mode:
        description: 'Sync mode'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
          - dry-run

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check configuration
        id: check-config
        run: |
          if {{SECRETS_CHECK}}; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::notice::Issue tracker not configured. Skipping sync. Configure the required secrets to enable."
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        if: steps.check-config.outputs.configured == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        if: steps.check-config.outputs.configured == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check-config.outputs.configured == 'true'
        run: npm ci || npm install

      - name: Configure Git
        if: steps.check-config.outputs.configured == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync issues
        if: steps.check-config.outputs.configured == 'true'
        env:
{{SECRETS_ENV}}
          BEADS_PROJECT_PATH: ${{ github.workspace }}
          SYNC_MODE: ${{ inputs.sync_mode || 'auto' }}
        run: npx hiveforge sync

      - name: Create Pull Request
        if: steps.check-config.outputs.configured == 'true' && success() && '{{AUTO_CREATE_PR}}' == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: sync issues from {{ISSUE_TRACKER_NAME}}'
          branch: sync/issues-to-beads
          delete-branch: true
          title: 'chore: Sync issues from {{ISSUE_TRACKER_NAME}}'
          body: |
            ## Automated Issue Sync

            This PR was automatically created by HiveForge.

            ### Changes
            - Synced issues from {{ISSUE_TRACKER_NAME}}
            - Updated `.beads/` directory with latest issue data

            ### Review
            - [ ] Verify issue metadata is correct
            - [ ] Check for any conflicts or duplicates

            ---
            *Generated by [HiveForge](https://hiveforge.sh)*
          labels: |
            automated
            sync
