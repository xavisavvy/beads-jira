// Jenkins Pipeline - Issue Sync
// Sync issues from {{ISSUE_TRACKER_NAME}} to local beads repository
// Generated by HiveForge - https://hiveforge.sh

pipeline {
    agent any

    triggers {
        // Scheduled sync - adjust cron expression as needed
        cron('{{SCHEDULE}}')
    }

    tools {
        nodejs 'NodeJS 18'
    }

    environment {
{{SECRETS_ENV}}
        BEADS_PROJECT_PATH = "${WORKSPACE}"
    }

    stages {
        stage('Check Configuration') {
            steps {
                script {
                    def configured = true
                    if ({{SECRETS_CHECK}}) {
                        echo 'Issue tracker not configured. Skipping sync.'
                        echo 'Configure the required credentials to enable sync.'
                        configured = false
                    }
                    env.CONFIGURED = configured.toString()
                }
            }
        }

        stage('Install Dependencies') {
            when {
                expression { env.CONFIGURED == 'true' }
            }
            steps {
                sh 'npm ci || npm install'
            }
        }

        stage('Sync Issues') {
            when {
                expression { env.CONFIGURED == 'true' }
            }
            steps {
                sh 'npx hiveforge sync'
            }
        }

        stage('Commit Changes') {
            when {
                expression { env.CONFIGURED == 'true' }
            }
            steps {
                sh '''
                    git config --global user.name "Jenkins"
                    git config --global user.email "jenkins@localhost"
                    git add .beads/
                    if ! git diff --cached --quiet; then
                        git commit -m "chore: sync issues from {{ISSUE_TRACKER_NAME}}"
                        git push origin HEAD:${GIT_BRANCH}
                    fi
                '''
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '.beads/**', allowEmptyArchive: true
        }
        success {
            echo 'Issue sync completed successfully!'
        }
        failure {
            echo 'Issue sync failed. Check the logs for details.'
        }
    }
}
