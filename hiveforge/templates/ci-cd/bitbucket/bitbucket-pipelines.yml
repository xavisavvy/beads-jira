# Bitbucket Pipelines Configuration - Issue Sync
# Sync issues from {{ISSUE_TRACKER_NAME}} to local beads repository
# Generated by HiveForge - https://hiveforge.sh

image: node:18

definitions:
  steps:
    - step: &sync-issues
        name: Sync Issues
        script:
          - |
            # Check configuration
            if {{SECRETS_CHECK}}; then
              echo "Issue tracker not configured. Skipping sync."
              echo "Configure the required repository variables to enable sync."
              exit 0
            fi
          - npm ci || npm install
          - npx hiveforge sync
          - |
            # Commit changes if any
            git config --global user.name "Bitbucket Pipelines"
            git config --global user.email "pipelines@bitbucket.org"
            git add .beads/
            if ! git diff --cached --quiet; then
              git commit -m "chore: sync issues from {{ISSUE_TRACKER_NAME}}"
              git push origin $BITBUCKET_BRANCH
            fi
        artifacts:
          - .beads/**

pipelines:
  custom:
    sync-issues:
      - step: *sync-issues

  # Uncomment to enable scheduled sync
  # Note: Schedules are configured in Bitbucket UI under Repository Settings > Schedules
  # schedules:
  #   - schedule:
  #       interval: "0 */6 * * *"  # Every 6 hours
  #       step: *sync-issues

  branches:
    main:
      - step:
          name: Skip auto sync on push
          script:
            - echo "Auto sync disabled on push. Use scheduled or manual trigger."
