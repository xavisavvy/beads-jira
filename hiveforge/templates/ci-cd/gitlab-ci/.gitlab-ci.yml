# GitLab CI Configuration - Issue Sync
# Sync issues from {{ISSUE_TRACKER_NAME}} to local beads repository
# Generated by HiveForge - https://hiveforge.sh

stages:
  - sync

variables:
  NODE_VERSION: "18"

sync-issues:
  stage: sync
  image: node:${NODE_VERSION}
  rules:
    # Scheduled pipeline
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Manual trigger
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  before_script:
    - |
      # Check if configured
      if {{SECRETS_CHECK}}; then
        echo "Issue tracker not configured. Skipping sync."
        echo "Configure the required variables to enable sync."
        exit 0
      fi
    - npm ci || npm install
  script:
    - npx hiveforge sync
    - |
      # Commit changes if any
      git config --global user.name "GitLab CI"
      git config --global user.email "gitlab-ci@gitlab.com"
      git add .beads/
      if ! git diff --cached --quiet; then
        git commit -m "chore: sync issues from {{ISSUE_TRACKER_NAME}}"
        git push "https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" HEAD:${CI_COMMIT_REF_NAME}
      fi
  variables:
{{SECRETS_ENV}}
    BEADS_PROJECT_PATH: $CI_PROJECT_DIR
  artifacts:
    paths:
      - .beads/
    expire_in: 1 week
