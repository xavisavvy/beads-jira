# Azure DevOps Pipeline - Issue Sync
# Sync issues from {{ISSUE_TRACKER_NAME}} to local beads repository
# Generated by HiveForge - https://hiveforge.sh

trigger: none

schedules:
  - cron: '{{SCHEDULE}}'
    displayName: 'Scheduled issue sync'
    branches:
      include:
        - main
        - master
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  - name: skipSync
    value: '{{SKIP_SCHEDULE}}'

stages:
  - stage: Sync
    displayName: 'Sync Issues'
    jobs:
      - job: CheckAndSync
        displayName: 'Check Configuration and Sync'
        steps:
          - task: NodeTool@0
            displayName: 'Setup Node.js'
            inputs:
              versionSpec: '18.x'

          - script: |
              if {{SECRETS_CHECK}}; then
                echo "##vso[task.logissue type=warning]Issue tracker not configured. Skipping sync."
                echo "##vso[task.setvariable variable=configured]false"
              else
                echo "##vso[task.setvariable variable=configured]true"
              fi
            displayName: 'Check Configuration'
            env:
{{SECRETS_ENV}}

          - script: npm ci || npm install
            displayName: 'Install Dependencies'
            condition: eq(variables.configured, 'true')

          - script: npx hiveforge sync
            displayName: 'Sync Issues'
            condition: eq(variables.configured, 'true')
            env:
{{SECRETS_ENV}}
              BEADS_PROJECT_PATH: $(Build.SourcesDirectory)

          - script: |
              git config --global user.name "Azure Pipelines"
              git config --global user.email "azuredevops@microsoft.com"
              git add .beads/
              git diff --cached --quiet || git commit -m "chore: sync issues from {{ISSUE_TRACKER_NAME}}"
              git push origin HEAD:$(Build.SourceBranchName)
            displayName: 'Commit and Push Changes'
            condition: and(eq(variables.configured, 'true'), succeeded())
